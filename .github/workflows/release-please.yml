name: Release PR (release-please)

on:
  # Run manifest sync on push to main (for keeping manifest in sync with releases)
  push:
    branches:
      - main
  # Run release-please after E2E tests pass
  workflow_run:
    workflows: ["Post-Merge E2E Tests"]
    types:
      - completed
    branches:
      - main

jobs:
  # Job 1: Sync manifest with existing releases (runs on push to main)
  sync-manifest:
    name: Sync manifest with releases
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MAINLINE_MERGE_TOKEN }}

      - name: Initialize VERSION file
        run: |
          # Create VERSION file from manifest if it doesn't exist
          if [ ! -f VERSION ]; then
            VERSION=$(jq -r '.["."]' .release-please-manifest.json)
            echo "$VERSION" > VERSION
            echo "Created VERSION file with version: $VERSION"
          else
            echo "VERSION file already exists"
          fi

      - name: Sync manifest with existing releases
        env:
          GITHUB_TOKEN: ${{ secrets.MAINLINE_MERGE_TOKEN }}
        run: |
          # Configure git for authentication
          git config user.name "chrisbot-release-workshop"
          git config user.email "chris+bot@releaseworkshop.com"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # Fetch all tags
          git fetch --tags

          # Find the latest release tag matching the component pattern (control-path-v*)
          LATEST_TAG=$(git tag -l "control-path-v*" | sort -V | tail -1)

          if [ -n "$LATEST_TAG" ]; then
            # Extract version from tag (e.g., control-path-v0.2.0 -> 0.2.0)
            VERSION=$(echo "$LATEST_TAG" | sed 's/^control-path-v//')
            echo "Latest release tag: $LATEST_TAG (version: $VERSION)"
            
            # Read current manifest
            CURRENT_VERSION=$(jq -r '.["."]' .release-please-manifest.json)
            echo "Current manifest version: $CURRENT_VERSION"
            
            # Compare versions and update if needed
            if [ "$(printf '%s\n' "$CURRENT_VERSION" "$VERSION" | sort -V | head -1)" != "$VERSION" ]; then
              echo "Updating manifest from $CURRENT_VERSION to $VERSION"
              jq --arg v "$VERSION" '.["."] = $v' .release-please-manifest.json > .release-please-manifest.json.tmp
              mv .release-please-manifest.json.tmp .release-please-manifest.json
              
              # Also update VERSION file
              echo "$VERSION" > VERSION
              
              # Commit the update if it changed
              git add .release-please-manifest.json VERSION
              if git diff --staged --quiet; then
                echo "No changes to commit"
              else
                git commit -m "chore: sync manifest and VERSION with release $VERSION" || echo "No changes to commit"
                git push origin main || echo "Failed to push manifest update (may already be up to date)"
              fi
            else
              echo "Manifest is already up to date"
            fi
          else
            echo "No release tags found"
          fi

  # Job 2: Run release-please (only runs after E2E tests pass)
  release-please:
    name: Run release-please
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MAINLINE_MERGE_TOKEN }}

      - name: Verify E2E tests passed
        run: |
          echo "✅ E2E tests passed for commit: ${{ github.event.workflow_run.head_sha }}"
          echo "✅ Proceeding with release PR creation/update"

      - name: Update release PR branch to match main
        env:
          GITHUB_TOKEN: ${{ secrets.MAINLINE_MERGE_TOKEN }}
        run: |
          RELEASE_BRANCH="release-please--branches--main"

          # Configure git for authentication
          git config user.name "chrisbot-release-workshop"
          git config user.email "chris+bot@releaseworkshop.com"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # Check if the release branch exists
          if git ls-remote --heads origin "$RELEASE_BRANCH" | grep -q "$RELEASE_BRANCH"; then
            echo "Release branch exists, updating it to match main..."
            git fetch origin "$RELEASE_BRANCH" || true
            git checkout -b "$RELEASE_BRANCH" "origin/$RELEASE_BRANCH" 2>/dev/null || git checkout "$RELEASE_BRANCH"
            
            # Update the branch to match main
            git reset --hard origin/main
            
            # Push the updated branch
            git push origin "$RELEASE_BRANCH" --force-with-lease || {
              echo "⚠️  Warning: Failed to update release branch (may be locked by release-please or already up to date)"
            }
            
            # Return to main
            git checkout main
          else
            echo "Release branch does not exist yet, release-please will create it"
          fi

      - name: Release PR and tags
        uses: googleapis/release-please-action@v4
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          token: ${{ secrets.MAINLINE_MERGE_TOKEN }}
