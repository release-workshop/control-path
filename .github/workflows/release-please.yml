name: Release PR (release-please)

on:
  push:
    branches:
      - main

jobs:
  release-please:
    name: Run release-please
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MAINLINE_MERGE_TOKEN }}

      - name: Initialize VERSION file
        run: |
          # Create VERSION file from manifest if it doesn't exist
          if [ ! -f VERSION ]; then
            VERSION=$(jq -r '.["."]' .release-please-manifest.json)
            echo "$VERSION" > VERSION
            echo "Created VERSION file with version: $VERSION"
          else
            echo "VERSION file already exists"
          fi

      - name: Sync manifest with existing releases
        env:
          GITHUB_TOKEN: ${{ secrets.MAINLINE_MERGE_TOKEN }}
        run: |
          # Configure git for authentication
          git config user.name "chrisbot-release-workshop"
          git config user.email "chris+bot@releaseworkshop.com"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # Fetch all tags
          git fetch --tags

          # Find the latest release tag matching the component pattern (control-path-v*)
          LATEST_TAG=$(git tag -l "control-path-v*" | sort -V | tail -1)

          if [ -n "$LATEST_TAG" ]; then
            # Extract version from tag (e.g., control-path-v0.2.0 -> 0.2.0)
            VERSION=$(echo "$LATEST_TAG" | sed 's/^control-path-v//')
            echo "Latest release tag: $LATEST_TAG (version: $VERSION)"
            
            # Read current manifest
            CURRENT_VERSION=$(jq -r '.["."]' .release-please-manifest.json)
            echo "Current manifest version: $CURRENT_VERSION"
            
            # Compare versions and update if needed
            if [ "$(printf '%s\n' "$CURRENT_VERSION" "$VERSION" | sort -V | head -1)" != "$VERSION" ]; then
              echo "Updating manifest from $CURRENT_VERSION to $VERSION"
              jq --arg v "$VERSION" '.["."] = $v' .release-please-manifest.json > .release-please-manifest.json.tmp
              mv .release-please-manifest.json.tmp .release-please-manifest.json
              
              # Also update VERSION file
              echo "$VERSION" > VERSION
              
              # Commit the update if it changed
              git add .release-please-manifest.json VERSION
              if git diff --staged --quiet; then
                echo "No changes to commit"
              else
                git commit -m "chore: sync manifest and VERSION with release $VERSION" || echo "No changes to commit"
                git push origin main || echo "Failed to push manifest update (may already be up to date)"
              fi
            else
              echo "Manifest is already up to date"
            fi
          else
            echo "No release tags found"
          fi

      - name: Check E2E test status
        env:
          GITHUB_TOKEN: ${{ secrets.MAINLINE_MERGE_TOKEN }}
        run: |
          echo "Checking if E2E tests have passed for the latest commit on main..."
          
          # Get the latest commit SHA on main
          COMMIT_SHA="${{ github.sha }}"
          echo "Checking commit: ${COMMIT_SHA}"
          
          # Wait a bit for e2e tests to start (if they haven't already)
          echo "Waiting 15 seconds for E2E tests to start (if triggered)..."
          sleep 15
          
          # Check for running or completed e2e workflow runs
          MAX_WAIT_TIME=600  # 10 minutes max wait (e2e tests can take time)
          WAIT_INTERVAL=15    # Check every 15 seconds
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_WAIT_TIME ]; do
            # Get the latest workflow run for "Post-Merge E2E Tests" workflow
            # Try by filename first (most reliable)
            WORKFLOW_RUN=$(curl -s \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/post-merge-e2e.yml/runs?branch=main&per_page=1" \
              | jq -r '.workflow_runs[0] // empty')
            
            # If not found, the workflow might not exist yet (first time setup)
            if [ -z "$WORKFLOW_RUN" ] || [ "$WORKFLOW_RUN" = "null" ]; then
              echo "⚠️  No E2E workflow run found. This might be the first run after creating the workflow."
              echo "⚠️  For safety, blocking release PR. Please ensure E2E tests are set up and passing."
              exit 1
            fi
            
            RUN_ID=$(echo "$WORKFLOW_RUN" | jq -r '.id')
            STATUS=$(echo "$WORKFLOW_RUN" | jq -r '.status')
            CONCLUSION=$(echo "$WORKFLOW_RUN" | jq -r '.conclusion // "null"')
            HEAD_SHA=$(echo "$WORKFLOW_RUN" | jq -r '.head_sha')
            
            echo "Found E2E workflow run #${RUN_ID} for commit ${HEAD_SHA}"
            echo "Status: ${STATUS}, Conclusion: ${CONCLUSION}"
            
            # Check if this run is for the current commit
            if [ "$HEAD_SHA" != "$COMMIT_SHA" ]; then
              echo "⚠️  E2E workflow run is for a different commit (${HEAD_SHA} vs ${COMMIT_SHA})"
              echo "⚠️  This might be a race condition. Checking if latest run passed..."
              # Check the conclusion - if it failed, block regardless of commit
              if [ "$CONCLUSION" = "failure" ] || [ "$CONCLUSION" = "cancelled" ]; then
                echo "❌ Latest E2E tests did not pass (conclusion: ${CONCLUSION})"
                echo "❌ Blocking release PR creation/update for safety"
                echo "View the failed run: https://github.com/${{ github.repository }}/actions/runs/${RUN_ID}"
                exit 1
              fi
              # If latest run passed but is for different commit, wait a bit more
              if [ "$STATUS" = "in_progress" ] || [ "$STATUS" = "queued" ]; then
                echo "E2E tests are running for a different commit. Waiting ${WAIT_INTERVAL}s... (${ELAPSED}s/${MAX_WAIT_TIME}s)"
                sleep $WAIT_INTERVAL
                ELAPSED=$((ELAPSED + WAIT_INTERVAL))
                continue
              fi
              # If latest run completed but is for different commit, we can't verify current commit
              echo "⚠️  Cannot verify E2E tests for current commit. Latest run is for different commit."
              echo "⚠️  For safety, blocking release PR. Please ensure E2E tests pass for this commit."
              exit 1
            fi
            
            # If workflow is still running, wait
            if [ "$STATUS" = "in_progress" ] || [ "$STATUS" = "queued" ]; then
              echo "E2E tests are still running (${STATUS}). Waiting ${WAIT_INTERVAL}s... (${ELAPSED}s/${MAX_WAIT_TIME}s)"
              sleep $WAIT_INTERVAL
              ELAPSED=$((ELAPSED + WAIT_INTERVAL))
              continue
            fi
            
            # Workflow has completed, check conclusion
            if [ "$CONCLUSION" = "success" ]; then
              echo "✅ E2E tests passed! Proceeding with release PR."
              break
            elif [ "$CONCLUSION" = "failure" ] || [ "$CONCLUSION" = "cancelled" ]; then
              echo "❌ E2E tests failed or were cancelled (conclusion: ${CONCLUSION})"
              echo "❌ Blocking release PR creation/update"
              echo ""
              echo "Please fix the E2E test failures before creating a release."
              echo "View the failed run: https://github.com/${{ github.repository }}/actions/runs/${RUN_ID}"
              exit 1
            elif [ "$CONCLUSION" = "null" ]; then
              echo "⚠️  E2E workflow completed but conclusion is null. Status: ${STATUS}"
              echo "⚠️  This might indicate the workflow was cancelled or is still processing."
              echo "⚠️  For safety, blocking release PR."
              exit 1
            else
              echo "⚠️  Unexpected conclusion: ${CONCLUSION}. For safety, blocking release PR."
              exit 1
            fi
          done
          
          if [ $ELAPSED -ge $MAX_WAIT_TIME ]; then
            echo "❌ Timeout waiting for E2E tests to complete (waited ${MAX_WAIT_TIME}s)"
            echo "❌ This might indicate the E2E workflow is stuck or taking too long."
            echo "❌ Blocking release PR to ensure safety."
            exit 1
          fi
          
          echo "✅ E2E check complete. Proceeding with release PR."

      - name: Update release PR branch to match main
        env:
          GITHUB_TOKEN: ${{ secrets.MAINLINE_MERGE_TOKEN }}
        run: |
          RELEASE_BRANCH="release-please--branches--main"

          # Configure git for authentication
          git config user.name "chrisbot-release-workshop"
          git config user.email "chris+bot@releaseworkshop.com"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # Check if the release branch exists
          if git ls-remote --heads origin "$RELEASE_BRANCH" | grep -q "$RELEASE_BRANCH"; then
            echo "Release branch exists, updating it to match main..."
            git fetch origin "$RELEASE_BRANCH" || true
            git checkout -b "$RELEASE_BRANCH" "origin/$RELEASE_BRANCH" 2>/dev/null || git checkout "$RELEASE_BRANCH"
            
            # Update the branch to match main
            git reset --hard origin/main
            
            # Push the updated branch
            git push origin "$RELEASE_BRANCH" --force-with-lease || {
              echo "⚠️  Warning: Failed to update release branch (may be locked by release-please or already up to date)"
            }
            
            # Return to main
            git checkout main
          else
            echo "Release branch does not exist yet, release-please will create it"
          fi

      - name: Release PR and tags
        uses: googleapis/release-please-action@v4
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          token: ${{ secrets.MAINLINE_MERGE_TOKEN }}
